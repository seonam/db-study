### 통계 정보

오라클 옵티마이저(Optimizer)는 SQL을 실행하기 전에 여러 실행계획 후보를 만들고, 그중 가장 비용(cost)이 낮다고 판단되는 계획을 선택하는 컴포넌트이다. 여기서 비용 계산의 핵심 입력값이 옵티마이저 통계(Optimizer Statistics) 이다.

옵티마이저 통계란 테이블, 컬럼, 인덱스의 데이터 양과 분포를 수치로 표현한 메타데이터이다. 옵티마이저는 이 통계를 기반으로 다음을 예측한다.

- 조건절을 적용했을 때 몇 건이 남을지 예측한다.
- 특정 접근 경로(인덱스 스캔, 풀 스캔 등)나 조인 방식을 선택했을 때 I/O, CPU, 메모리 사용량이 어느 정도일지 추정한다.
- 그 추정 결과를 하나의 점수처럼 비용(cost) 으로 환산하고 비교한다.

### 수집 정보

#### 테이블 통계

테이블 통계는 테이블(또는 파티션)의 크기와 기본 형태를 나타낸다.
- NUM_ROWS : 테이블의 전체 행 수이다.
- BLOCKS : 사용 중인 데이터 블록 수이다.
- AVG_ROW_LEN : 평균 행 길이이다.

이 값들은 주로 아래를 판단할 때 쓰인다.
- 풀 테이블 스캔 시 얼마나 읽을지 추정한다.
- 조인 시 한쪽 입력 데이터가 얼마나 클지 추정한다.

#### 컬럼 통계

컬럼 통계는 값의 분포를 나타낸다.

- NUM_DISTINCT(NDV) : 서로 다른 값의 개수이다.
  - 예: 성별 컬럼이면 NDV는 보통 2~3 수준이다. 
  - 예: 주문번호 컬럼이면 NDV는 행 수와 비슷한 수준이다.
- DENSITY : 동등 조건(col = ?)의 평균 선택도에 대한 힌트 값이다.
- NUM_NULLS : NULL 개수이다.
- LOW_VALUE, HIGH_VALUE : 값 범위의 하한/상한이다(내부 표현으로 저장되며 그대로 사람이 읽기 어려울 수 있다).
- HISTOGRAM
  - 값 분포가 균등하지 않은 경우를 위한 분포 정보
  - 예를 들어 주문 상태가 DONE이 99%이고 CANCEL이 1%라면, status = 'CANCEL'은 매우 선택도가 높아 인덱스를 타는 것이 유리할 가능성이 크다. 그런데 히스토그램이 없고 평균 NDV로만 계산하면 이런 스큐(skew)를 제대로 반영하지 못할 수 있다.
  - DONE/CANCEL 이므로 옵티마이저는 5:5로 생각할 수 있다.
  - 스큐(skew) 란 특정 값이 유난히 많이 나타나 분포가 한쪽으로 치우친 상태이다.
  - 히스토그램은 이런 치우침을 반영해 선택도 추정을 보정한다.

#### 인덱스 통계
인덱스 통계는 인덱스 구조와 접근 비용을 나타낸다.

- BLEVEL : 인덱스 루트부터 리프까지의 높이이다. 높을수록 인덱스 탐색 비용이 증가한다.
- LEAF_BLOCKS : 리프 블록 수이다. 인덱스 크기/밀도에 영향을 준다.
- DISTINCT_KEYS : 인덱스 키의 NDV이다.
- CLUSTERING_FACTOR : 인덱스 순서와 테이블 레코드 배치의 “군집 정도”를 나타내는 값이다.

#### 변경량 정보
통계를 실시간으로 수집하면 좋지만 비용이 크다. 그래서 오라클은 통계가 오래되었는지(stale)를 판단하기 위해 변경량 정보를 사용한다.

- 테이블에 대해 insert/update/delete 가 얼마나 발생했는지
- truncate가 있었는지
- 마지막 통계 수집 이후 얼마나 변했는지

이 정보는 대표적으로 DBA_TAB_MODIFICATIONS 같은 뷰에서 확인한다.

참고로 여기서 스테일은 통계가 현재 데이터 상태를 충분히 반영하지 못할 정도로 오래되었다는 의미이며, 오라클은 변경량과 설정값을 기준으로 STALE_STATS = YES로 표시할 수 있다. 


### 통계 저장

옵티마이저 통계는 오라클의 데이터 딕셔너리에 저장된다. 데이터 딕셔너리란 오라클 내부의 메타데이터(오브젝트 정의, 권한, 통계 등)를 관리하는 시스템 영역이다. 사용자는 DBA_, ALL_, USER_로 시작하는 뷰를 통해 이를 조회한다.

통계 확인에 자주 쓰는 뷰는 다음과 같다.

- 테이블 통계 뷰: *_TAB_STATISTICS
- 컬럼 통계 뷰: *_TAB_COL_STATISTICS
- 인텍스 통계 뷰: *_IND_STATISTICS
- 변경량 뷰: *_TAB_MODIFICATIONS

### 통계 수집

통계는 오라클이 자동으로 수집하거나 DBA 또는 운영 배치가 수동으로 실행하는 DBMS_STATS 기반으로 수집된다.

#### 자동 수집

오라클은 보통 Automatic Maintenance Tasks 를 통해 통계를 자동 수집한다. 자동 통계 수집은 내부적으로 통계가 없거나 스테일한 객체를 찾아서 수집하는 방식으로 동작한다. 즉, 매번 모든 테이블을 훑는 방식이 아니라 필요한 것만 갱신하는 형태이다.

이 자동 작업이 실제로 언제 수행되는지는 시스템 설정(maintenance window, job 설정 등)에 좌우된다.

운영에서는 이 자동 수집을 기본으로 두되, 대량 배치 직후 같은 이벤트에는 수동 수집을 추가하는 방식이 흔하다.

#### DBMS_STATS

DBMS_STATS 는 통계 수집·관리·복원·내보내기 등을 제공하는 오라클 내장 패키지이다.
- 테이블/인덱스/스키마/데이터베이스 단위로 통계를 수집한다.
- 샘플링 비율, 히스토그램 정책, 스테일 기준 등 여러 설정을 제어한다.
- 통계가 성능에 미치는 영향이 큰 만큼 운영 표준으로 DBMS_STATS를 사용한다.

과거에는 ANALYZE TABLE ... COMPUTE STATISTICS 같은 문법이 쓰이기도 했지만, 현대 운영에서는 DBMS_STATS 가 표준이다.


### 마무리

통계에 오류가 있는 경우 옵티마이저의 비용 산정이 틀어지고, 결과적으로 실행계획이 틀어진다. 즉, 아래와 같은 문제가 발생할 수 있다.

#### 풀 스캔과 인덱스 선택 

- 실제로는 0.1%만 읽어야 하는데 통계가 틀려서 30%로 추정하면 인덱스를 포기하고 풀 스캔을 선택할 수 있다.
- 반대로 실제로는 80%를 읽는데 1%로 추정하면 비효율적인 인덱스 접근을 선택할 수 있다.

#### 조인 순서


### 마무리

실행 계획에 문제가 없는데 슬로우 쿼리가 발생한 경우 통계가 의심되면 아래를 확인해보자.

1. 실행계획이 바뀌었는지 확인한다.
2. 관련 테이블/인덱스의 LAST_ANALYZED, STALE_STATS를 확인한다.
3. 컬럼 분포(히스토그램/NDV)가 실제 데이터와 맞는지 확인한다.
4. 변경량이 큰데 통계가 갱신되지 않았는지 확인한다.
5. 필요하면 통계를 수집하거나, 통계 적용을 보류(pending)하고 검증 후 반영한다.


